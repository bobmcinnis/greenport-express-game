<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Greenport Express — Engineer’s View</title>
<style>
  :root{--bg:#0b1220;--fg:#e5e7eb}
  html,body{height:100%;margin:0}
  body{font:14px/1.4 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;background:#0b1220;color:#e5e7eb}
  .wrap{position:fixed;inset:0;background:var(--bg);color:var(--fg)}
  .head{position:absolute;top:0;left:0;right:0;display:flex;align-items:center;justify-content:center;gap:12px;
        background:#fff;color:#0b1220;padding:10px 14px;box-shadow:0 10px 30px rgba(2,6,23,.12);z-index:3}
  .head h1{margin:0;font-size:18px}
  .badge{font-size:12px;color:#fff;background:linear-gradient(135deg,#0ea5e9,#22d3ee);padding:4px 8px;border-radius:999px}
  .headtoggle{position:absolute;left:14px}
  .scene{position:absolute;inset:44px 0 0 0}
  .hud{position:absolute;left:50%;bottom:12px;transform:translateX(-50%);display:flex;align-items:center;gap:12px;
       padding:10px 12px;border-radius:14px;background:rgba(255,255,255,.9);backdrop-filter:blur(8px);
       box-shadow:0 10px 30px rgba(2,6,23,.15);z-index:3;color:#0b1220}
  .ctl{display:grid;gap:6px;font-size:12px;color:#64748b}
  .sp{width:1px;align-self:stretch;background:rgba(100,116,139,.3)}
  .btn{appearance:none;border:0;background:#0ea5e9;color:#fff;padding:9px 12px;border-radius:12px;cursor:pointer}
  .ghost{background:transparent;border:1px solid rgba(100,116,139,.4);color:#0b1220}
  .range{-webkit-appearance:none;appearance:none;width:220px;height:6px;border-radius:999px;background:rgba(100,116,139,.45)}
  .range::-webkit-slider-thumb{-webkit-appearance:none;width:18px;height:18px;border-radius:50%;background:#0ea5e9;border:2px solid rgba(255,255,255,.9)}
  .hidden{display:none!important}
  .dark{--bg:#0b1220;--fg:#e5e7eb}
  #status{position:absolute;top:52px;left:12px;z-index:4;font-size:12px;color:#0369a1}
</style>
</head>
<body>
<div class="wrap">
  <div class="head">
    <div class="headtoggle"><button id="toggleHeadline" class="ghost btn">Headline: On</button></div>
    <h1 id="headline">Greenport Express</h1>
    <span class="badge">Engineer’s View — Through the Woods</span>
  </div>
  <div id="status">Loading…</div>
  <div class="scene" id="scene"></div>
  <div class="hud">
    <div class="ctl">
      <label for="speed">Speed</label>
      <input id="speed" class="range" type="range" min="0" max="40" value="12" />
    </div>
    <div style="font-size:12px;color:#64748b"><strong id="mph">12</strong> mph</div>
    <div class="sp"></div>
    <button id="whistle" class="btn">Blow Whistle</button>
    <button id="bell" class="btn ghost">Bell</button>
    <div class="sp"></div>
    <button id="dark" class="btn">Dark Mode</button>
    <button id="look" class="btn ghost">Look Around</button>
    <button id="center" class="btn ghost">Center View</button>
  </div>
</div>

<!-- Local Three.js so no CDNs are required -->
<script src="./three.min.js"></script>
<script>
(function(){
  const statusEl = document.getElementById('status');
  const log = m => (statusEl.textContent = m);

  if (!window.THREE){ log('ERROR: three.min.js not found next to index.html'); return; }
  const THREE = window.THREE;

  // Renderer / Scene / Camera
  const container = document.getElementById('scene');
  const renderer = new THREE.WebGLRenderer({ antialias:true });
  renderer.setPixelRatio(Math.min(window.devicePixelRatio||1, 2));
  renderer.shadowMap.enabled = true;
  container.appendChild(renderer.domElement);

  const scene = new THREE.Scene();
  scene.fog = new THREE.FogExp2(0xcfe8ff, 0.0045);

  const camera = new THREE.PerspectiveCamera(70, 1, 0.05, 2000);

  // Lights
  const hemi = new THREE.HemisphereLight(0xe8f7ff, 0x274a2c, 0.7); scene.add(hemi);
  const sun = new THREE.DirectionalLight(0xffffff, 1.0);
  sun.position.set(60,80,40); sun.castShadow=true; sun.shadow.mapSize.set(2048,2048);
  scene.add(sun);

  // Ground
  const ground = new THREE.Mesh(
    new THREE.CircleGeometry(420,64),
    new THREE.MeshPhongMaterial({ color: 0xbfe7c1 })
  );
  ground.rotation.x = -Math.PI/2; ground.receiveShadow = true; scene.add(ground);

  // Track
  const TRACK_RADIUS = 60, GAUGE = 1.435;
  function CirclePath(r){ this.radius=r; }
  CirclePath.prototype = Object.create(THREE.Curve.prototype);
  CirclePath.prototype.getPoint=function(t){ const a=t*Math.PI*2; return new THREE.Vector3(Math.cos(a)*this.radius,0,Math.sin(a)*this.radius); };

  const RAIL_R = 0.08;
  const railMat = new THREE.MeshStandardMaterial({ color:0x6b7280, metalness:.9, roughness:.25 });
  const innerRail = new THREE.Mesh(new THREE.TubeGeometry(new CirclePath(TRACK_RADIUS-GAUGE/2), 480, RAIL_R, 12, true), railMat);
  const outerRail = new THREE.Mesh(new THREE.TubeGeometry(new CirclePath(TRACK_RADIUS+GAUGE/2), 480, RAIL_R, 12, true), railMat);
  innerRail.castShadow = outerRail.castShadow = true;
  innerRail.receiveShadow = outerRail.receiveShadow = true;
  scene.add(innerRail, outerRail);

  const ballast = new THREE.Mesh(
    new THREE.RingGeometry(TRACK_RADIUS-GAUGE/2-1.5, TRACK_RADIUS+GAUGE/2+1.5, 128),
    new THREE.MeshStandardMaterial({ color:0x8e99a3, roughness:1 })
  );
  ballast.geometry.rotateX(-Math.PI/2); ballast.receiveShadow = true; scene.add(ballast);

  // Ties
  const TIE_CT = 360, TIE_W = GAUGE + 0.9, TIE_H = 0.18, TIE_D = 0.32;
  const tieGeo = new THREE.BoxGeometry(TIE_W, TIE_H, TIE_D);
  const tieMat = new THREE.MeshStandardMaterial({ color:0x7b5e3b, roughness:.9 });
  const ties = new THREE.InstancedMesh(tieGeo, tieMat, TIE_CT);
  const m4 = new THREE.Matrix4(), q = new THREE.Quaternion();
  for(let i=0;i<TIE_CT;i++){
    const t = i/TIE_CT, ang = t*Math.PI*2, x = Math.cos(ang)*TRACK_RADIUS, z = Math.sin(ang)*TRACK_RADIUS;
    q.setFromEuler(new THREE.Euler(0, ang, 0));
    m4.compose(new THREE.Vector3(x, -TIE_H/2 + 0.01, z), q, new THREE.Vector3(1,1,1));
    ties.setMatrixAt(i, m4);
  }
  ties.castShadow = ties.receiveShadow = true; scene.add(ties);

  // Train (engine + car) and engineer mount
  const wheel = ()=>{ const g=new THREE.CylinderGeometry(1,1,0.8,20), m=new THREE.MeshStandardMaterial({color:0x333,metalness:.5,roughness:.5}); const w=new THREE.Mesh(g,m); w.rotation.z=Math.PI/2; w.castShadow=true; return w; };
  const engineMesh = ()=>{
    const g=new THREE.Group();
    const boiler=new THREE.Mesh(new THREE.CylinderGeometry(1.8,1.8,7.2,24), new THREE.MeshStandardMaterial({color:0x1967d2,metalness:.2,roughness:.6}));
    boiler.rotation.z=Math.PI/2; boiler.position.set(0,2.2,0); boiler.castShadow=true; g.add(boiler);
    const cab=new THREE.Mesh(new THREE.BoxGeometry(3.6,3,3.2), new THREE.MeshStandardMaterial({color:0x154466}));
    cab.position.set(-3.2,2.6,0); cab.castShadow=true; g.add(cab);
    const chimney=new THREE.Mesh(new THREE.CylinderGeometry(0.6,0.9,1.8,16), new THREE.MeshStandardMaterial({color:0x111}));
    chimney.position.set(3.0,3.2,0); chimney.castShadow=true; g.add(chimney);
    const pilot=new THREE.Mesh(new THREE.ConeGeometry(1.2,1.8,4), new THREE.MeshStandardMaterial({color:0x0f172a,metalness:.1,roughness:.7}));
    pilot.rotation.z=Math.PI/2; pilot.position.set(4.2,1.3,0); g.add(pilot);
    const w1=wheel(); w1.position.set(-2.2,1.0,1.1);
    const w2=wheel(); w2.position.set(-2.2,1.0,-1.1);
    const w3=wheel(); w3.position.set(1.8,1.0,1.1);
    const w4=wheel(); w4.position.set(1.8,1.0,-1.1);
    g.add(w1,w2,w3,w4);
    const cabMount = new THREE.Object3D(); cabMount.position.set(1.2,2.3,0.0); g.add(cabMount); g.userData.cabMount=cabMount;
    return g;
  };
  const carMesh = (color)=>{
    const g=new THREE.Group();
    const body=new THREE.Mesh(new THREE.BoxGeometry(5.6,2.2,2.8), new THREE.MeshStandardMaterial({color:color||0x22c55e}));
    body.position.y=2.0; body.castShadow=true; g.add(body);
    const w1=wheel(); w1.position.set(-1.8,1.0,1.1);
    const w2=wheel(); w2.position.set(-1.8,1.0,-1.1);
    const w3=wheel(); w3.position.set(1.8,1.0,1.1);
    const w4=wheel(); w4.position.set(1.8,1.0,-1.1);
    g.add(w1,w2,w3,w4);
    return g;
  };

  const train = new THREE.Group();
  const engine = engineMesh();
  const car1 = carMesh(0x22c55e); car1.position.x = -6.8;
  train.add(engine, car1);
  scene.add(train);

  // Trees
  const addTree=(x,z,s=1)=>{
    const trunk=new THREE.Mesh(new THREE.CylinderGeometry(.4*s,.6*s,3*s,8), new THREE.MeshStandardMaterial({color:0x6b4f2c}));
    trunk.position.set(x,1.5*s,z); trunk.castShadow=trunk.receiveShadow=true; scene.add(trunk);
    const mat=new THREE.MeshStandardMaterial({color:0x2a7a3b,roughness:.9});
    const c1=new THREE.Mesh(new THREE.ConeGeometry(2.0*s,3.6*s,8),mat); c1.position.set(x,3.6*s,z); c1.castShadow=true;
    const c2=new THREE.Mesh(new THREE.ConeGeometry(1.6*s,3.0*s,8),mat); c2.position.set(x,5.2*s,z); c2.castShadow=true;
    scene.add(c1,c2);
  };
  const rand=(a,b)=>a+Math.random()*(b-a);
  for(let i=0;i<420;i++){ const r=rand(64,380), th=rand(0,Math.PI*2); addTree(Math.cos(th)*r, Math.sin(th)*r, rand(.7,1.4)); }
  for(let i=0;i<160;i++){ const r=rand(82,220), th=rand(0,Math.PI*2); if(Math.abs(r-TRACK_RADIUS)>10) addTree(Math.cos(th)*r, Math.sin(th)*r, rand(.6,1.1)); }

  // Engineer view mount
  const yaw = new THREE.Object3D();
  const pitch = new THREE.Object3D();
  engine.userData.cabMount.add(yaw); yaw.add(pitch); pitch.add(camera);
  camera.position.set(0,0,0);

  // Pointer‑lock look around
  let yawDeg = 0, pitchDeg = 0;
  const clamp = (v,a,b)=>Math.max(a,Math.min(b,v));
  const lookBtn = document.getElementById("look");
  const centerBtn = document.getElementById("center");

  function onMouseMove(e){
    if (document.pointerLockElement !== renderer.domElement) return;
    yawDeg += e.movementX * 0.08;
    pitchDeg -= e.movementY * 0.08;
    pitchDeg = clamp(pitchDeg, -60, 60);
    yaw.rotation.y = THREE.MathUtils.degToRad(yawDeg);
    pitch.rotation.x = THREE.MathUtils.degToRad(pitchDeg);
  }
  renderer.domElement.addEventListener("mousemove", onMouseMove);
  lookBtn.addEventListener("click", ()=>{ if(renderer.domElement.requestPointerLock) renderer.domElement.requestPointerLock(); });
  centerBtn.addEventListener("click", ()=>{ yawDeg=pitchDeg=0; yaw.rotation.y=0; pitch.rotation.x=0; });

  // UI
  const $ = id=>document.getElementById(id);
  let mph = parseFloat($("speed").value);
  $("mph").textContent = String(mph);
  $("speed").addEventListener("input", ()=>{ mph=parseFloat($("speed").value); $("mph").textContent=String(mph); });

  // Audio: whistle + bell
  const audio = new (window.AudioContext||window.webkitAudioContext)();
  const whistle = ()=>{
    const o=audio.createOscillator(), g=audio.createGain();
    g.gain.value=0.001; o.type='sine';
    o.frequency.setValueAtTime(720,audio.currentTime);
    o.frequency.exponentialRampToValueAtTime(1100,audio.currentTime+0.35);
    o.frequency.exponentialRampToValueAtTime(680,audio.currentTime+0.9);
    g.gain.exponentialRampToValueAtTime(0.5,audio.currentTime+0.04);
    g.gain.exponentialRampToValueAtTime(0.32,audio.currentTime+0.4);
    g.gain.exponentialRampToValueAtTime(0.001,audio.currentTime+1.0);
    o.connect(g).connect(audio.destination); o.start(); o.stop(audio.currentTime+1.05);
  };
  const bell = ()=>{
    const o1=audio.createOscillator(), o2=audio.createOscillator(), g=audio.createGain();
    o1.type=o2.type='sine'; o1.frequency.value=660; o2.frequency.value=990;
    g.gain.value=0.001;
    g.gain.exponentialRampToValueAtTime(0.35,audio.currentTime+0.02);
    g.gain.exponentialRampToValueAtTime(0.001,audio.currentTime+0.6);
    o1.connect(g); o2.connect(g); g.connect(audio.destination);
    o1.start(); o2.start(); o1.stop(audio.currentTime+0.65); o2.stop(audio.currentTime+0.65);
  };
  $("whistle").addEventListener("click", ()=>{ if(audio.state==='suspended') audio.resume(); whistle(); });
  $("bell").addEventListener("click", ()=>{ if(audio.state==='suspended') audio.resume(); bell(); });

  // Headline + Dark mode
  let headlineOn = true;
  document.getElementById("toggleHeadline").addEventListener("click", ()=>{
    headlineOn = !headlineOn;
    document.getElementById("headline").classList.toggle("hidden", !headlineOn);
    document.getElementById("toggleHeadline").textContent = `Headline: ${headlineOn ? "On" : "Off"}`;
  });
  const setDark = on=>{
    document.querySelector(".wrap").classList.toggle("dark", on);
    if(on){ scene.fog.color.set(0x0b1220); renderer.setClearColor(0x0b1220,1); hemi.intensity=.35; sun.intensity=.6; }
    else { scene.fog.color.set(0xcfe8ff); renderer.setClearColor(0xcfe8ff,1); hemi.intensity=.7; sun.intensity=1.0; }
  };
  setDark(false);
  document.getElementById("dark").addEventListener("click", ()=> setDark(!document.querySelector(".wrap").classList.contains("dark")));

  // Resize
  function fit(){
    const r = container.getBoundingClientRect();
    const w = Math.max(1,r.width), h = Math.max(1,r.height);
    camera.aspect = w/h; camera.updateProjectionMatrix(); renderer.setSize(w,h,false);
  }
  new ResizeObserver(fit).observe(container); fit();

  // Keyboard
  window.addEventListener("keydown", e=>{
    if(e.code==="Space") whistle();
    if(e.key==="b"||e.key==="B") bell();
    if(e.key==="d"||e.key==="D") setDark(!document.querySelector(".wrap").classList.contains("dark"));
  });

  // Motion around loop
  const clock = new THREE.Clock();
  let theta = 0;
  (function animate(){
    const dt = clock.getDelta();
    const mps = (mph * 1609.344) / 3600;
    const angVel = mps / TRACK_RADIUS;
    theta += angVel * dt;

    const x = Math.cos(theta) * TRACK_RADIUS;
    const z = Math.sin(theta) * TRACK_RADIUS;
    const dx = -Math.sin(theta), dz = Math.cos(theta);
    train.position.set(x,0,z);
    train.rotation.y = Math.atan2(dz, dx);

    renderer.render(scene, camera);
    requestAnimationFrame(animate);
  })();

  log("Engineer’s View — Through the Woods");
})();
</script>
</body>
</html>
