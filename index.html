<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Greenport Express — Miniature Railroad World</title>
<style>
  :root{--bg:#0b1220;--fg:#e5e7eb}
  html,body{height:100%;margin:0}
  body{font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;background:#0b1220;color:#e5e7eb}
  .wrap{position:fixed;inset:0;background:var(--bg);color:var(--fg)}
  .head{position:absolute;top:0;left:0;right:0;display:flex;align-items:center;justify-content:center;gap:12px;background:#fff;color:#0b1220;padding:10px 14px;box-shadow:0 10px 30px rgba(2,6,23,.12);z-index:3}
  .head h1{margin:0;font-size:18px}
  .badge{font-size:12px;color:#fff;background:linear-gradient(135deg,#0ea5e9,#22d3ee);padding:4px 8px;border-radius:999px}
  .headtoggle{position:absolute;left:14px}
  .scene{position:absolute;inset:44px 0 0 0}
  .hud{position:absolute;left:50%;bottom:12px;transform:translateX(-50%);display:flex;align-items:center;gap:12px;padding:10px 12px;border-radius:14px;background:rgba(255,255,255,.95);backdrop-filter:blur(8px);box-shadow:0 10px 30px rgba(2,6,23,.15);z-index:3;color:#0b1220;flex-wrap:wrap}
  .ctl{display:grid;gap:6px;font-size:12px;color:#64748b}
  .sp{width:1px;align-self:stretch;background:rgba(100,116,139,.3)}
  .btn{appearance:none;border:0;background:#0ea5e9;color:#fff;padding:9px 12px;border-radius:12px;cursor:pointer}
  .ghost{background:transparent;border:1px solid rgba(100,116,139,.4);color:#0b1220}
  .range{-webkit-appearance:none;appearance:none;width:220px;height:6px;border-radius:999px;background:rgba(100,116,139,.45)}
  .range::-webkit-slider-thumb{-webkit-appearance:none;width:18px;height:18px;border-radius:50%;background:#0ea5e9;border:2px solid rgba(255,255,255,.9)}
  .hidden{display:none!important}
  #status{position:absolute;top:52px;left:12px;z-index:4;font-size:12px;color:#0369a1}

  .pad{position:absolute;right:14px;bottom:14px;z-index:3;display:grid;grid-template-columns:56px 56px 56px;grid-template-rows:56px 56px 56px;gap:8px}
  .pad button{appearance:none;border:0;border-radius:10px;background:rgba(255,255,255,.95);box-shadow:0 6px 18px rgba(2,6,23,.15);color:#0b1220;font-weight:700;cursor:pointer}
  .pad .blank{visibility:hidden}

  .ribbon{position:absolute;top:52px;right:12px;z-index:4;background:rgba(255,255,255,.95);color:#0b1220;border-radius:12px;padding:10px 12px;box-shadow:0 10px 30px rgba(2,6,23,.15);min-width:220px}
  .ribbon .row{display:flex;align-items:center;justify-content:space-between;margin:2px 0}
  .tag{padding:2px 8px;border-radius:999px;background:#e2e8f0;font-size:12px}
</style>
</head>
<body>
<div class="wrap">
  <div class="head">
    <div class="headtoggle"><button id="toggleHeadline" class="ghost btn">Headline: On</button></div>
    <h1 id="headline">Greenport Express</h1>
    <span class="badge">Kids’ Miniature Railroad — Explore Greenport!</span>
  </div>

  <div id="status">Loading…</div>
  <div class="scene" id="scene"></div>

  <div class="ribbon">
    <div class="row"><strong>Score:</strong> <span id="score">0</span></div>
    <div class="row"><span class="tag">Shells</span><span id="shells">0 / 12</span></div>
    <div class="row"><span class="tag">Passengers</span><span id="pax">0</span></div>
    <hr style="border:none;border-top:1px solid #e5e7eb;margin:8px 0">
    <div style="font-size:12px;color:#334155">Daily Mission</div>
    <div id="mission" style="font-size:13px">Pick up 6 passengers at the Carnival.</div>
    <button id="reroll" class="btn ghost" style="margin-top:6px;padding:6px 10px">New Mission</button>
  </div>

  <div class="hud">
    <div class="ctl">
      <label for="speed">Speed</label>
      <input id="speed" class="range" type="range" min="0" max="35" value="12" />
    </div>
    <div style="font-size:12px;color:#64748b"><strong id="mph">12</strong> mph</div>
    <div class="sp"></div>
    <button id="whistle" class="btn">Whistle</button>
    <button id="bell" class="btn ghost">Bell</button>
    <div class="sp"></div>
    <button id="dark" class="btn">Night</button>
    <button id="tall" class="btn ghost" title="See over the cars">Tall: Off</button>
    <button id="center" class="btn ghost">Center View</button>
    <button id="photo" class="btn ghost">Photo</button>
  </div>

  <!-- On‑screen look pad -->
  <div class="pad" aria-label="look controls">
    <span class="blank"></span><button id="padUp">↑</button><span class="blank"></span>
    <button id="padLeft">←</button><span class="blank"></span><button id="padRight">→</button>
    <span class="blank"></span><button id="padDown">↓</button><span class="blank"></span>
  </div>
</div>

<!-- Only local Three.js (place three.min.js next to this file) -->
<script src="./three.min.js"></script>
<script>
(function(){
  const setStatus = m => (document.getElementById('status').textContent = m);
  if(!window.THREE){ setStatus('ERROR: three.min.js not found next to index.html'); return; }
  const THREE = window.THREE;

  // ==== Renderer & scene ====
  const container = document.getElementById('scene');
  const renderer = new THREE.WebGLRenderer({ antialias:true, preserveDrawingBuffer:true });
  renderer.setPixelRatio(Math.min(window.devicePixelRatio||1, 2));
  renderer.shadowMap.enabled = true;
  renderer.shadowMap.type = THREE.PCFSoftShadowMap;
  renderer.outputColorSpace = THREE.SRGBColorSpace;
  renderer.toneMapping = THREE.ACESFilmicToneMapping;
  container.appendChild(renderer.domElement);

  const scene = new THREE.Scene();

  // Env (simple gradient env map)
  const pmrem = new THREE.PMREMGenerator(renderer);
  const envCanvas = document.createElement('canvas'); envCanvas.width = envCanvas.height = 256;
  const eg = envCanvas.getContext('2d'); const grd = eg.createLinearGradient(0,0,0,256);
  grd.addColorStop(0,'#cfe8ff'); grd.addColorStop(1,'#9fc3ff'); eg.fillStyle=grd; eg.fillRect(0,0,256,256);
  const envTex = new THREE.CanvasTexture(envCanvas); envTex.colorSpace = THREE.SRGBColorSpace;
  scene.environment = pmrem.fromEquirectangular(envTex).texture; envTex.dispose();

  // Camera: we’ll directly set quaternion each frame (yaw+pitch applied after base forward)
  const camera = new THREE.PerspectiveCamera(72, 1, 0.05, 2500);
  scene.add(camera);

  // Lighting
  const hemi = new THREE.HemisphereLight(0xffffff, 0x2a3b2a, 0.6); scene.add(hemi);
  const sun = new THREE.DirectionalLight(0xffffff, 2.1); sun.position.set(90,140,60);
  sun.castShadow = true; sun.shadow.mapSize.set(2048,2048);
  sun.shadow.camera.near=1; sun.shadow.camera.far=600;
  sun.shadow.camera.left=-160; sun.shadow.camera.right=160; sun.shadow.camera.top=160; sun.shadow.camera.bottom=-160;
  scene.add(sun);
  const nightGroup = new THREE.Group(); nightGroup.visible=false; scene.add(nightGroup);

  // Ground disk
  const ground = new THREE.Mesh(new THREE.CircleGeometry(900, 128), new THREE.MeshStandardMaterial({ color:0x98cfa7, roughness:0.95 }));
  ground.rotation.x = -Math.PI/2; ground.receiveShadow=true; scene.add(ground);

  // Track
  const TRACK_RADIUS=85, GAUGE=0.6;
  function CirclePath(r){ this.radius=r; } CirclePath.prototype = Object.create(THREE.Curve.prototype);
  CirclePath.prototype.getPoint=function(t){ const a=t*Math.PI*2; return new THREE.Vector3(Math.cos(a)*this.radius,0,Math.sin(a)*this.radius); };
  const railMat = new THREE.MeshStandardMaterial({ color:0x7e8790, metalness:1.0, roughness:0.25, envMapIntensity:1.2 });
  const innerRail = new THREE.Mesh(new THREE.TubeGeometry(new CirclePath(TRACK_RADIUS-GAUGE/2),960,0.055,16,true), railMat);
  const outerRail = new THREE.Mesh(new THREE.TubeGeometry(new CirclePath(TRACK_RADIUS+GAUGE/2),960,0.055,16,true), railMat);
  innerRail.castShadow=outerRail.castShadow=true; innerRail.receiveShadow=outerRail.receiveShadow=true; scene.add(innerRail,outerRail);
  const ballast = new THREE.Mesh(new THREE.RingGeometry(TRACK_RADIUS-GAUGE/2-1.2, TRACK_RADIUS+GAUGE/2+1.2, 200),
                                 new THREE.MeshStandardMaterial({color:0x8e99a3, roughness:1}));
  ballast.geometry.rotateX(-Math.PI/2); ballast.receiveShadow=true; scene.add(ballast);

  // Trees (fast)
  const trunkGeo=new THREE.CylinderGeometry(0.35,0.45,2.8,10);
  const trunkMat=new THREE.MeshStandardMaterial({color:0x6b4f2c,roughness:.95});
  const foliageMat=new THREE.MeshStandardMaterial({color:0x2f7a4a,roughness:.9,metalness:0,envMapIntensity:0.2});
  const rnd=(a,b)=>a+Math.random()*(b-a);
  function addTree(x,z,s){
    const t=new THREE.Mesh(trunkGeo,trunkMat); t.scale.set(s,s,s); t.position.set(x,1.4*s,z); t.castShadow=t.receiveShadow=true; scene.add(t);
    [[1.7,3.0,3.0],[1.4,2.6,4.4],[1.1,2.2,5.7]].forEach(([r,h,y])=>{
      const c=new THREE.Mesh(new THREE.ConeGeometry(r*s,h*s,12), foliageMat); c.position.set(x,y*s,z); c.castShadow=true; scene.add(c);
    });
  }
  for(let i=0;i<900;i++){ const r=rnd(95,860), th=rnd(0,Math.PI*2); addTree(Math.cos(th)*r,Math.sin(th)*r,rnd(.6,1.25)); }
  for(let i=0;i<280;i++){ const r=rnd(110,280), th=rnd(0,Math.PI*2); if(Math.abs(r-TRACK_RADIUS)>12) addTree(Math.cos(th)*r,Math.sin(th)*r,rnd(.6,1.0)); }

  // Minimal POIs (ferris / lighthouse / harbor / skate) — unchanged details for brevity
  const POI=[]; function addPOI(name,ang,group){ POI.push({name,ang,group}); scene.add(group); }
  function placeAround(g,ang,r){ g.position.set(Math.cos(ang)*r,0,Math.sin(ang)*r); g.lookAt(0,0,0); }

  const carnival=new THREE.Group(), wheel=new THREE.Group(), wheelR=7;
  wheel.add(new THREE.Mesh(new THREE.TorusGeometry(wheelR,0.18,8,48), new THREE.MeshStandardMaterial({color:0xffffff, roughness:.4})));
  carnival.add(wheel); addPOI('Carnival', Math.PI*0.05, carnival);

  const lightHouse=new THREE.Group();
  const tower=new THREE.Mesh(new THREE.CylinderGeometry(1.5,2.2,12,16), new THREE.MeshStandardMaterial({color:0xffffff, roughness:.9}));
  const cap=new THREE.Mesh(new THREE.ConeGeometry(1.8,2,16), new THREE.MeshStandardMaterial({color:0xcc0000, roughness:.6}));
  cap.position.y=7; tower.position.y=5; lightHouse.add(tower,cap);
  const beam=new THREE.SpotLight(0xffeeaa, 12, 120, Math.PI/16, 0.35, 1.0); beam.position.set(0,10.2,0); beam.target.position.set(10,9,0);
  nightGroup.add(beam,beam.target); addPOI('Lighthouse', Math.PI*0.62, lightHouse);

  const harbor=new THREE.Group(); const water=new THREE.Mesh(new THREE.CircleGeometry(55,48), new THREE.MeshStandardMaterial({color:0x69b3ff, metalness:.1, roughness:.4}));
  water.rotation.x=-Math.PI/2; harbor.add(water); addPOI('Harbor', Math.PI*0.80, harbor);

  const skate=new THREE.Group(); const ramp=new THREE.Mesh(new THREE.CylinderGeometry(4,4,6,24,1,true,0,Math.PI/2), new THREE.MeshStandardMaterial({color:0xbfc9d1, roughness:.8}));
  ramp.rotation.z=Math.PI/2; skate.add(ramp); addPOI('Skate Park', Math.PI*0.38, skate);

  POI.forEach(p=>placeAround(p.group, p.ang, TRACK_RADIUS+18));

  // Train + riders (kept from your last working version)
  const CAR_CT=24, CAR_SP=2.2;
  const carMat=new THREE.MeshStandardMaterial({ color:0xbfc5cc, metalness:.85, roughness:.35, envMapIntensity:1.5 });
  function coalCar(){ const g=new THREE.Group(); const box=new THREE.Mesh(new THREE.BoxGeometry(1.8,0.7,1.2),carMat); box.castShadow=box.receiveShadow=true; g.add(box); return g; }
  const train=new THREE.Group(), cars=[]; for(let i=0;i<CAR_CT;i++){ const c=coalCar(); cars.push(c); train.add(c); } scene.add(train);

  const ANGLE_PER_M = 1 / TRACK_RADIUS;
  const ARC_SPACING = CAR_SP * ANGLE_PER_M;
  function placeCar(car, angle){
    const x = Math.cos(angle)*TRACK_RADIUS, z = Math.sin(angle)*TRACK_RADIUS;
    const tx = -Math.sin(angle), tz = Math.cos(angle);
    car.position.set(x,0,z); car.rotation.y = Math.atan2(tx,tz);
  }

  // Collectibles + stops (light)
  const shellsGroup=new THREE.Group(); scene.add(shellsGroup);
  const shellMat=new THREE.MeshStandardMaterial({color:0xfff3bf, metalness:.2, roughness:.5});
  const shellGeo=new THREE.SphereGeometry(0.12,12,10); const SHELL_CT=12;
  for(let i=0;i<SHELL_CT;i++){ const a=Math.random()*Math.PI*2, r=TRACK_RADIUS+(Math.random()<.5?-1.2:1.2);
    const s=new THREE.Mesh(shellGeo,shellMat); s.position.set(Math.cos(a)*r,0.12,Math.sin(a)*r); shellsGroup.add(s); }
  const stops=[]; function addStop(name,ang){ const g=new THREE.Group(); g.add(new THREE.Mesh(new THREE.BoxGeometry(3.5,0.2,1.2), new THREE.MeshStandardMaterial({color:0x333})));
    placeAround(g,ang,TRACK_RADIUS-2.2); scene.add(g); stops.push({name,ang,group:g}); }
  addStop('Carnival Station', Math.PI*0.05+0.03);
  addStop('Harbor Dock', Math.PI*0.80+0.06);

  // ===== UI / state =====
  const $=id=>document.getElementById(id);
  let mph=parseFloat($("speed").value); $("mph").textContent=String(mph);
  $("speed").addEventListener("input",()=>{ mph=parseFloat($("speed").value); $("mph").textContent=String(mph); });

  let yawDeg=0, pitchDeg=0;                // your controls
  const PITCH_MIN=-80, PITCH_MAX=80;       // wider range for clear look down/up
  let eyeY = 0.62, targetEye = 0.62;       // seated height
  const SEATED=0.62, TALL=1.05;

  // input: arrows and pad
  window.addEventListener('keydown',e=>{
    const step=4;
    if(e.key==='ArrowLeft')  yawDeg-=step;
    if(e.key==='ArrowRight') yawDeg+=step;
    if(e.key==='ArrowUp')    pitchDeg=Math.min(PITCH_MAX, pitchDeg+step);
    if(e.key==='ArrowDown')  pitchDeg=Math.max(PITCH_MIN, pitchDeg-step);
  });
  function hold(btn,fn){ let t=null; const start=ev=>{ev.preventDefault(); if(t) return; fn(); t=setInterval(fn,80)}; const stop=()=>{clearInterval(t);t=null};
    btn.addEventListener('pointerdown',start); btn.addEventListener('pointerup',stop); btn.addEventListener('pointerleave',stop); btn.addEventListener('pointercancel',stop); }
  hold($("padLeft"), ()=>{yawDeg-=4}); hold($("padRight"), ()=>{yawDeg+=4});
  hold($("padUp"), ()=>{pitchDeg=Math.min(PITCH_MAX, pitchDeg+3)});
  hold($("padDown"), ()=>{pitchDeg=Math.max(PITCH_MIN, pitchDeg-3)});

  // drag look (mouse/touch)
  (function attachDrag(){
    const el=renderer.domElement; let drag=false,lx=0,ly=0;
    const s=0.18; const P=e=>e.touches?{x:e.touches[0].clientX,y:e.touches[0].clientY}:{x:e.clientX,y:e.clientY};
    const down=e=>{drag=true; const p=P(e); lx=p.x; ly=p.y; el.setPointerCapture?.(e.pointerId||0);};
    const move=e=>{ if(!drag) return; const p=P(e); const dx=p.x-lx, dy=p.y-ly; lx=p.x; ly=p.y; yawDeg+=dx*s; pitchDeg=Math.max(PITCH_MIN,Math.min(PITCH_MAX,pitchDeg-dy*s)); };
    const up=()=>drag=false;
    el.addEventListener('pointerdown',down); el.addEventListener('pointermove',move); el.addEventListener('pointerup',up); el.addEventListener('pointerleave',up);
    el.addEventListener('touchstart',down,{passive:false}); el.addEventListener('touchmove',move,{passive:false}); el.addEventListener('touchend',up);
  })();

  // Tall / center / dark / headline / audio / photo
  $("tall").addEventListener("click",()=>{ targetEye = (targetEye===SEATED?TALL:SEATED); $("tall").textContent=`Tall: ${targetEye===TALL?'On':'Off'}`; $("tall").classList.toggle('ghost', targetEye!==TALL); });
  $("center").addEventListener("click",()=>{ yawDeg=0; pitchDeg=0; });
  let isNight=false; function setNight(on){ isNight=on; nightGroup.visible=on; renderer.setClearColor(on?0x06101f:0xcfe8ff,1); hemi.intensity=on?.25:.6; sun.intensity=on?1.1:2.1; $("dark").textContent=on?'Day':'Night'; }
  setNight(false); $("dark").addEventListener("click",()=>setNight(!isNight));
  let headOn=true; $("toggleHeadline").addEventListener("click",()=>{ headOn=!headOn; $("headline").classList.toggle('hidden',!headOn); $("toggleHeadline").textContent=`Headline: ${headOn?'On':'Off'}`; });
  const audio=new (window.AudioContext||window.webkitAudioContext)();
  $("whistle").addEventListener("click",()=>{ if(audio.state==='suspended') audio.resume(); const o=audio.createOscillator(),g=audio.createGain(); g.gain.value=.001;o.type='sine';
    o.frequency.setValueAtTime(720,audio.currentTime); o.frequency.exponentialRampToValueAtTime(1100,audio.currentTime+.35); o.frequency.exponentialRampToValueAtTime(680,audio.currentTime+.9);
    g.gain.exponentialRampToValueAtTime(.5,audio.currentTime+.04); g.gain.exponentialRampToValueAtTime(.32,audio.currentTime+.4); g.gain.exponentialRampToValueAtTime(.001,audio.currentTime+1.0);
    o.connect(g).connect(audio.destination); o.start(); o.stop(audio.currentTime+1.05); });
  $("bell").addEventListener("click",()=>{ if(audio.state==='suspended') audio.resume(); const o1=audio.createOscillator(),o2=audio.createOscillator(),g=audio.createGain(); o1.type=o2.type='sine'; o1.frequency.value=660;o2.frequency.value=990; g.gain.value=.001;
    g.gain.exponentialRampToValueAtTime(.35,audio.currentTime+.02); g.gain.exponentialRampToValueAtTime(.001,audio.currentTime+.6); o1.connect(g);o2.connect(g);g.connect(audio.destination); o1.start();o2.start();o1.stop(audio.currentTime+.65);o2.stop(audio.currentTime+.65); });
  $("photo").addEventListener("click",()=>{ const a=document.createElement('a'); a.download='greenport-express.png'; a.href=renderer.domElement.toDataURL('image/png'); a.click(); });

  // Resize
  function fit(){ const r=container.getBoundingClientRect(), w=Math.max(1,r.width), h=Math.max(1,r.height); camera.aspect=w/h; camera.updateProjectionMatrix(); renderer.setSize(w,h,false); }
  new ResizeObserver(fit).observe(container); fit();

  // Game loop with **quaternion-based look**
  const clock=new THREE.Clock(); let theta=0; let shells=0, pax=0, score=0;
  const $score=()=>document.getElementById('score').textContent=score, $shells=()=>document.getElementById('shells').textContent=`${shells} / ${SHELL_CT}`, $pax=()=>document.getElementById('pax').textContent=pax;
  $score(); $shells(); $pax();

  function animate(){
    const dt=clock.getDelta();
    const mph=parseFloat(document.getElementById('speed').value); document.getElementById('mph').textContent = String(mph);
    const mps=(mph*1609.344)/3600; const angVel=mps/TRACK_RADIUS; theta += angVel*dt;

    // move cars
    for(let i=0;i<CAR_CT;i++) placeCar(cars[i], theta - i*ARC_SPACING);

    // ride position (10 cars back)
    const rideAng = theta - (10*ARC_SPACING);
    const pos = new THREE.Vector3(Math.cos(rideAng)*TRACK_RADIUS, eyeY, Math.sin(rideAng)*TRACK_RADIUS);

    // smooth eye height
    eyeY += (targetEye - eyeY) * 0.12;
    pos.y = eyeY + Math.sin(clock.elapsedTime*2.5)*0.015;

    // base forward (along tangent)
    const forward = new THREE.Vector3(-Math.sin(rideAng), 0, Math.cos(rideAng)).normalize();
    const up = new THREE.Vector3(0,1,0);

    // Build orientation: base -> yaw -> pitch  (QUATERNION method = reliable everywhere)
    const baseQuat = new THREE.Quaternion().setFromUnitVectors(new THREE.Vector3(0,0,-1), forward);
    const yawQ   = new THREE.Quaternion().setFromAxisAngle(up, THREE.MathUtils.degToRad(yawDeg));
    const right  = new THREE.Vector3().copy(forward).cross(up).normalize();
    const pitchQ = new THREE.Quaternion().setFromAxisAngle(right, THREE.MathUtils.degToRad(pitchDeg));
    const camQ   = new THREE.Quaternion().multiply(baseQuat).multiply(yawQ).multiply(pitchQ);

    camera.position.copy(pos);
    camera.quaternion.copy(camQ);

    // animate bits
    wheel.rotation.z += 0.35*dt;
    if(nightGroup.visible){ beam.target.position.set(Math.cos(clock.elapsedTime*0.5)*40,6,Math.sin(clock.elapsedTime*0.5)*40); }

    // collectibles near train
    const trainPos = new THREE.Vector3(pos.x,0,pos.z);
    shellsGroup.children.forEach(m=>{ if(m.visible && m.position.distanceTo(trainPos)<1.2){ m.visible=false; shells++; score+=50; $score(); $shells(); } });
    stops.forEach(s=>{ const d=Math.abs(Math.atan2(Math.sin(rideAng-s.ang), Math.cos(rideAng-s.ang))); if(d<0.03 && mps>0.1){ pax++; score+=100; $score(); $pax(); s.ang += 0.8 + Math.random()*0.6; placeAround(s.group, s.ang, TRACK_RADIUS-2.2); } });

    renderer.render(scene,camera);
    requestAnimationFrame(animate);
  }
  animate();

  // small UI bits
  const missions=['Pick up 6 passengers at the Carnival.','Collect 5 shells near the Harbor.','Finish a lap under 2:30 minutes.','Whistle at the Lighthouse and Skate Park.'];
  function reroll(){ document.getElementById('mission').textContent = missions[Math.floor(Math.random()*missions.length)]; }
  reroll(); document.getElementById('reroll').addEventListener('click', reroll);

  setStatus('Use mouse/touch or arrows to look **up AND down**. Tall toggles eye height.');
})();
</script>
</body>
</html>
